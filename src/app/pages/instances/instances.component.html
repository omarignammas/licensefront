<p-toast></p-toast>

<p-toolbar styleClass="mb-6">
  <ng-template #start>
    <p-button
      label="New"
      icon="pi pi-plus"
      severity="secondary"
      class="mr-2"
      (onClick)="openNew()" />
    <p-button
      severity="secondary"
      label="Delete"
      icon="pi pi-trash"
      outlined
      (onClick)="deleteSelectedInstances()"
      [disabled]="!selectedInstances || !selectedInstances.length" />

    <!-- ✅ Dropdown filters -->
    <p-dropdown
      [options]="clients"
      optionLabel="name"
      optionValue="id"
      placeholder="Filter by Client"
      [(ngModel)]="selectedClientId"
      (onChange)="filterInstances()" 
      class="ml-3 w-48" />

    <p-dropdown
      [options]="applications"
      optionLabel="name"
      optionValue="id"
      placeholder="Filter by Application"
      [(ngModel)]="selectedApplicationId"
      (onChange)="filterInstances()"
      class="ml-3 w-48" />

    <p-dropdown
      [options]="environments"
      optionLabel="name"
      optionValue="id"
      placeholder="Filter by Environment"
      [(ngModel)]="selectedEnvironmentId"
      (onChange)="filterInstances()"
      class="ml-3 w-48" />
  </ng-template>

  <ng-template #end>
    <p-iconfield>
      <p-inputicon styleClass="pi pi-search" />
      <input
        pInputText
        type="text"
        (input)="onGlobalFilter(dt, $event)"
        placeholder="Search..." />
    </p-iconfield>
  </ng-template>
</p-toolbar>

<p-table
    #dt
    [value]="instances()"
    [rows]="10"
    [paginator]="true"
    [totalRecords]="totalRecords" 
    [rowsPerPageOptions]="[10,20,30]"
    [(selection)]="selectedInstances"
    dataKey="tag"
    (onLazyLoad)="loadInstancesLazy($event)"
    [lazy]="true">
  <ng-template #caption>
    <h5 class="m-0">Manage Instances</h5>
  </ng-template>

  <ng-template #header>
    <tr>
      <th style="width: 3rem">
        <p-tableHeaderCheckbox />
      </th>
      <th>Tag</th>
      <th>Branch Name</th>
      <th pSortableColumn="dateInstallation">
          Date Installation
          <p-sortIcon field="dateInstallation" />
      </th>
      <th>Application</th>
      <th>Client</th>
      <th>Environment</th>
      <th pSortableColumn="status">
          Status
          <p-sortIcon field="status" />
      </th>
      <th>Operations</th>
    </tr>
  </ng-template>

  <ng-template #body let-instance>
    <tr>
      <td>
        <p-tableCheckbox [value]="instance" />
      </td>
      <td>
        <p-tag [value]="instance.tag" [severity]="getSeverity(instance.tag)" />
      </td>
      <td>{{ instance.branchName }}</td>
      <td>{{ instance.dateInstallation }}</td>
      <td>{{ instance.application?.name }}</td>
      <td><p-tag [value]="instance.client.name" [severity]="getSeverity(instance.client.name)" /></td>
      <td>{{ instance.environment?.name }}</td>
      <td>
        <p-tag [value]="instance.status" [severity]="getSeverity(instance.status)" />
      </td>
      <td>
        <p-button
          icon="pi pi-pencil"
          class="mr-2"
          [rounded]="true"
          [outlined]="true"
          (click)="editInstance(instance)" />
        <p-button
          icon="pi pi-trash"
          severity="danger"
          [rounded]="true"
          [outlined]="true"
          (click)="deleteInstance(instance)" />
      </td>
    </tr>
  </ng-template>
</p-table>

<!-- ✅ Form dialog -->
<p-dialog [(visible)]="instanceDialog" [style]="{ width: '650px' }" header="Instance Details" [modal]="true">
    <ng-template #content>
      <div class="grid grid-cols-2 gap-6"> <!-- 2 columns uniform -->
  
        <!-- Tag -->
        <div class="flex items-center gap-3">
          <label class="w-32 font-bold">Tag</label>
          <input type="text" pInputText [(ngModel)]="instance.tag" placeholder="Enter tag" class="flex-1" />
        </div>
  
        <!-- Branch -->
        <div class="flex items-center gap-3">
          <label class="w-32 font-bold">Branch</label>
          <input type="text" pInputText [(ngModel)]="instance.branchName" placeholder="Enter branch" class="flex-1" />
        </div>
  
        <!-- Date -->
        <div class="flex items-center gap-3">
          <label class="w-32 font-bold">Date</label>
          <p-datepicker 
            [(ngModel)]="instance.dateInstallation" 
            inputId="date"
            showIcon
            iconDisplay="input"
            appendTo="body"
            dataType="date"
            class="flex-1"
          />
        </div>
  
        <!-- Status -->
        <div class="flex items-center gap-3">
          <label class="w-32 font-bold">Status</label>
          <p-select [(ngModel)]="instance.status" [options]="statuses" optionLabel="label" optionValue="value" placeholder="Select" class="flex-1"/>
        </div>
  
        <!-- Application -->
        <div class="flex items-center gap-3">
          <label class="w-32 font-bold">Application</label>
          <p-select [(ngModel)]="instance.application" [options]="applications" optionLabel="name" placeholder="Select app" class="flex-1"/>
        </div>
  
        <!-- Client -->
        <div class="flex items-center gap-3">
          <label class="w-32 font-bold">Client</label>
          <p-select [(ngModel)]="instance.client" [options]="clients" optionLabel="name" placeholder="Select client" class="flex-1"/>
        </div>
  
        <!-- Environment (full row if needed) -->
        <div class="flex items-center gap-3">
            <label class="w-32 font-bold">Client</label>
            <p-select [(ngModel)]="instance.environment" appendTo="body" [options]="environments" optionLabel="name" placeholder="Select environment" class="flex-1"/>
          </div>
  
      </div>
    </ng-template>
  
    <ng-template #footer>
      <p-button label="Cancel" icon="pi pi-times" text (click)="hideDialog()" />
      <p-button label="Save" icon="pi pi-check" (click)="saveInstance()" />
    </ng-template>
  </p-dialog>
  
  <p-confirmdialog [style]="{ width: '450px' }" />


